<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Proveedores - FerreCotiza</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            text-align: center; 
            color: white; 
            margin-bottom: 40px; 
            padding: 20px 0; 
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .nav-tab:hover {
            color: #2563eb;
        }
        
        .quote-list {
            display: grid;
            gap: 20px;
        }
        .quote-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .quote-item:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .quote-item.pending {
            border-left: 5px solid #f59e0b;
        }
        .quote-item.responded {
            border-left: 5px solid #10b981;
        }
        .quote-item.expired {
            border-left: 5px solid #ef4444;
            opacity: 0.7;
        }
        
        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .company-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
        }
        .quote-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-responded {
            background: #dcfce7;
            color: #166534;
        }
        .status-expired {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .quote-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .meta-item {
            text-align: center;
        }
        .meta-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .meta-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .quote-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #2563eb;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .quote-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .quote-meta { grid-template-columns: 1fr; }
            .quote-actions { flex-direction: column; }
            .nav-tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard de Cotizaciones</h1>
            <p id="supplierName">Gestiona tus licitaciones</p>
        </div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Mis Cotizaciones</h2>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesión</button>
            </div>
            
            <!-- Estadísticas -->
            <div class="stats-grid" id="statsGrid">
                <!-- Se cargarán las estadísticas aquí -->
            </div>
            
            <!-- Tabs de navegación -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('pending')">
                    Pendientes
                </div>
                <div class="nav-tab" onclick="switchTab('responded')">
                    Cotizadas
                </div>
                <div class="nav-tab" onclick="switchTab('expired')">
                    Vencidas
                </div>
                <div class="nav-tab" onclick="switchTab('all')">
                    Todas
                </div>
            </div>
            
            <!-- Lista de cotizaciones -->
            <div id="quotesContainer" class="quote-list">
                <!-- Las cotizaciones se cargarán aquí -->
            </div>
        </div>
    </div>
    
    <script>
        let currentSupplier = null;
        let allQuotes = [];
        let activeTab = 'pending';
        
        // Obtener proveedor del localStorage o redirigir al login
        function initDashboard() {
            const supplier = localStorage.getItem('currentSupplier');
            if (!supplier) {
                window.location.href = '/suppliers';
                return;
            }
            
            currentSupplier = JSON.parse(supplier);
            document.getElementById('supplierName').textContent = currentSupplier.name;
            loadAllQuotes();
        }
        
        async function loadAllQuotes() {
            if (!currentSupplier) return;
            
            try {
                // Cargar cotizaciones activas
                const activeResponse = await fetch(`/api/suppliers/${currentSupplier.id}/quotes`);
                const activeData = await activeResponse.json();
                
                // Cargar cotizaciones vencidas
                const expiredResponse = await fetch(`/api/suppliers/${currentSupplier.id}/quotes/expired`);
                const expiredData = await expiredResponse.json();
                
                allQuotes = [
                    ...activeData.quotes.map(q => ({ ...q, is_expired: false })),
                    ...(expiredData.quotes || []).map(q => ({ ...q, is_expired: true }))
                ];
                
                updateStats();
                displayQuotes();
                
            } catch (error) {
                console.error('Error cargando cotizaciones:', error);
            }
        }
        
        function updateStats() {
            const pending = allQuotes.filter(q => !q.is_expired && q.quote_status === 'sent').length;
            const responded = allQuotes.filter(q => q.quote_status === 'responded').length;
            const expired = allQuotes.filter(q => q.is_expired).length;
            const total = allQuotes.length;
            
            const totalValue = allQuotes
                .filter(q => q.current_response)
                .reduce((sum, q) => sum + q.current_response.total_amount, 0);
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${pending}</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-number">${responded}</div>
                    <div class="stat-label">Cotizadas</div>
                </div>
                <div class="stat-card" style="border-left-color: #ef4444;">
                    <div class="stat-number">${expired}</div>
                    <div class="stat-label">Vencidas</div>
                </div>
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-number">$${totalValue.toLocaleString()}</div>
                    <div class="stat-label">Valor Cotizado</div>
                </div>
            `;
        }
        
        function switchTab(tab) {
            activeTab = tab;
            
            // Actualizar tabs activos
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            displayQuotes();
        }
        
        function displayQuotes() {
            const container = document.getElementById('quotesContainer');
            let filteredQuotes = [];
            
            switch(activeTab) {
                case 'pending':
                    filteredQuotes = allQuotes.filter(q => !q.is_expired && q.quote_status === 'sent');
                    break;
                case 'responded':
                    filteredQuotes = allQuotes.filter(q => q.quote_status === 'responded');
                    break;
                case 'expired':
                    filteredQuotes = allQuotes.filter(q => q.is_expired);
                    break;
                case 'all':
                    filteredQuotes = allQuotes;
                    break;
            }
            
            if (filteredQuotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <h3>No hay cotizaciones en esta categoría</h3>
                        <p>Las nuevas licitaciones aparecerán aquí</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredQuotes.forEach(quote => {
                const isExpired = quote.is_expired || new Date(quote.response_deadline) < new Date();
                const hasResponse = quote.quote_status === 'responded';
                const timeLeft = getTimeLeft(quote.response_deadline);
                
                html += `
                    <div class="quote-item ${isExpired ? 'expired' : hasResponse ? 'responded' : 'pending'}" 
                         onclick="openQuote('${quote.id}')">
                        <div class="quote-header">
                            <div class="company-name">${quote.company_name}</div>
                            <div class="quote-status ${isExpired ? 'status-expired' : hasResponse ? 'status-responded' : 'status-pending'}">
                                ${isExpired ? 'Vencida' : hasResponse ? 'Cotizada' : 'Pendiente'}
                            </div>
                        </div>
                        
                        <div style="color: #6b7280; margin-bottom: 10px;">
                            ${quote.delivery_address}
                        </div>
                        
                        <div class="quote-meta">
                            <div class="meta-item">
                                <div class="meta-label">Productos</div>
                                <div class="meta-value">${quote.products?.length || 0} items</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Solicitud</div>
                                <div class="meta-value">${new Date(quote.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">${isExpired ? 'Venció' : 'Vence'}</div>
                                <div class="meta-value">${timeLeft}</div>
                            </div>
                            ${hasResponse ? `
                                <div class="meta-item">
                                    <div class="meta-label">Mi Cotización</div>
                                    <div class="meta-value">$${quote.current_response.total_amount.toLocaleString()}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="quote-actions" onclick="event.stopPropagation()">
                            ${!isExpired ? `
                                <button class="btn ${hasResponse ? 'btn-warning' : 'btn-success'}" 
                                        onclick="openQuote('${quote.id}')">
                                    ${hasResponse ? 'Modificar' : 'Cotizar'}
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="viewDetails('${quote.id}')">
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getTimeLeft(deadline) {
            const now = new Date();
            const end = new Date(deadline);
            const diff = end - now;
            
            if (diff <= 0) {
                return 'Vencida';
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h restantes`;
            } else {
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                return `${minutes}m restantes`;
            }
        }
        
        function openQuote(quoteId) {
            // Redirigir a la página de cotización específica
            window.location.href = `/suppliers?quote=${quoteId}`;
        }
        
        function viewDetails(quoteId) {
            // Mostrar modal con detalles completos
            const quote = allQuotes.find(q => q.id === quoteId);
            if (quote) {
                alert(`Detalles de ${quote.company_name}\n\nProductos: ${quote.products?.length || 0}\nContacto: ${quote.contact_name}\nEmail: ${quote.email}`);
            }
        }
        
        function logout() {
            localStorage.removeItem('currentSupplier');
            window.location.href = '/suppliers';
        }
        
        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);
        
        // Actualizar cada 30 segundos
        setInterval(loadAllQuotes, 30000);
    </script>
</body>
</html>
